{% extends "base.html" %}

{% block title %}{{ title }} - WasmWiz{% endblock %}

{% block content %}
<!-- Notification Banner Area -->
<div id="notification-area"></div>

<!-- Modern Dashboard Layout -->
<div class="dashboard-layout">
    <!-- Main Panel -->
    <div class="main-panel">
        <!-- Primary Upload Card -->
        <div class="modern-card">
            <div class="modern-card-header">
                <h1 class="modern-card-title">
                    üöÄ Execute WebAssembly Module
                </h1>
                <p class="modern-card-subtitle">
                    Upload and execute WebAssembly modules securely in our sandboxed environment.
                    <strong>No account required</strong> for basic execution.
                </p>
            </div>
            
            <div class="modern-card-body">
                <form id="execute-form" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    
                    <!-- Enhanced File Upload Zone -->
                    <div class="modern-form-group">
                        <label for="wasm-file" class="modern-form-label">
                            üìÅ WebAssembly File (.wasm)
                        </label>
                        <div class="enhanced-upload-zone" id="drop-area">
                            <input type="file" id="wasm-file" name="wasm" accept=".wasm" style="display: none;">
                            <div class="upload-icon-modern">
                                üìÑ
                            </div>
                            <p class="upload-text-modern">Drop your .wasm file here or click to browse</p>
                            <p class="upload-subtext-modern">Maximum file size: 10MB ‚Ä¢ Supports all WASM modules</p>
                        </div>
                        <div class="file-info" id="file-info" style="display: none;">
                            <div class="file-details">
                                <span class="file-name" id="file-name"></span>
                                <span class="file-size" id="file-size"></span>
                                <button type="button" class="remove-file" id="remove-file">Remove</button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabbed Input Interface -->
                    <div class="modern-form-group">
                        <label class="modern-form-label">üí¨ Input Data</label>
                        <div class="input-tabs">
                            <button type="button" class="input-tab active" data-input-type="text">
                                Plain Text
                            </button>
                            <button type="button" class="input-tab" data-input-type="json">
                                JSON
                            </button>
                            <button type="button" class="input-tab" data-input-type="binary">
                                Binary (Base64)
                            </button>
                        </div>
                        <div class="input-content">
                            <textarea 
                                id="input-text" 
                                name="input" 
                                class="modern-form-input" 
                                placeholder="Enter input data for your WebAssembly module (optional)..."
                                rows="6"
                                style="font-family: 'Fira Code', monospace; resize: vertical;"
                            ></textarea>
                            <small class="text-secondary">Maximum input size: 1MB</small>
                        </div>
                    </div>

                    <!-- Collapsible Advanced Options -->
                    <div class="collapsible-section" id="advanced-options">
                        <div class="collapsible-header">
                            <h3 class="collapsible-title">‚öôÔ∏è Advanced Execution Options</h3>
                            <span class="collapsible-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <div class="execution-options">
                                <div class="option-group">
                                    <label for="memory-limit">üíæ Memory Limit</label>
                                    <div class="range-display">
                                        <input type="range" id="memory-limit" class="range-input" min="16" max="128" value="128" step="16">
                                        <span class="value-display" id="memory-display">128 MB</span>
                                    </div>
                                </div>
                                <div class="option-group">
                                    <label for="timeout">‚è±Ô∏è Timeout</label>
                                    <div class="range-display">
                                        <input type="range" id="timeout" class="range-input" min="1" max="5" value="5" step="1">
                                        <span class="value-display" id="timeout-display">5 sec</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Collapsible API Key Section -->
                    <div class="collapsible-section" id="api-key-section">
                        <div class="collapsible-header">
                            <h3 class="collapsible-title">üîë API Key (Optional)</h3>
                            <span class="collapsible-icon">‚ñº</span>
                        </div>
                        <div class="collapsible-content">
                            <input 
                                type="password" 
                                id="api-key" 
                                class="modern-form-input" 
                                placeholder="Enter your API key for enhanced features..."
                            >
                            <small class="text-secondary" style="margin-top: 0.5rem; display: block;">
                                üéÅ <strong>Enhanced features:</strong> execution logs, result downloads, higher rate limits<br>
                                <a href="/api-keys" style="color: var(--primary-color);">Generate an API key</a> or 
                                <a href="#" id="sign-in-link" style="color: var(--primary-color);">sign in to your account</a>
                            </small>
                        </div>
                    </div>

                    <!-- Modern Progress Indicator -->
                    <div class="modern-progress" id="progress-container" style="display: none;">
                        <div class="progress-header">
                            <span class="progress-title">Processing your WebAssembly module...</span>
                            <span class="progress-percentage" id="progress-percentage">0%</span>
                        </div>
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progress-bar"></div>
                        </div>
                        <div class="progress-steps-modern">
                            <div class="progress-step-modern" id="step-upload">
                                <div class="step-indicator">1</div>
                                <div class="step-label-modern">Uploading</div>
                            </div>
                            <div class="progress-step-modern" id="step-execute">
                                <div class="step-indicator">2</div>
                                <div class="step-label-modern">Executing</div>
                            </div>
                            <div class="progress-step-modern" id="step-results">
                                <div class="step-indicator">3</div>
                                <div class="step-label-modern">Results</div>
                            </div>
                        </div>
                    </div>

                    <div id="validation-errors"></div>

                    <!-- Primary Action Button -->
                    <button type="submit" id="submit-button" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem; font-weight: 600;">
                        üöÄ Execute WebAssembly Module
                    </button>
                </form>
            </div>
        </div>

        <!-- Execution Results -->
        <div id="execution-result"></div>

        <!-- How to Use Guide -->
        <div class="modern-card" style="margin-top: 2rem;">
            <div class="modern-card-header">
                <h2 class="modern-card-title">üìö How to Use WasmWiz</h2>
            </div>
            <div class="modern-card-body">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üõ†Ô∏è</div>
                        <h3 style="color: var(--secondary-color); margin-bottom: 0.5rem;">1. Prepare</h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            Compile your C, C++, or Rust code to WebAssembly using tools like Emscripten or wasm-pack.
                        </p>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üì§</div>
                        <h3 style="color: var(--secondary-color); margin-bottom: 0.5rem;">2. Upload</h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            Drag and drop your .wasm file or select it from the file browser.
                        </p>
                    </div>
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚ö°</div>
                        <h3 style="color: var(--secondary-color); margin-bottom: 0.5rem;">3. Execute</h3>
                        <p style="color: var(--text-secondary); font-size: 0.875rem;">
                            Click execute to run your module securely in our sandboxed environment.
                        </p>
                    </div>
                </div>
                
                <div class="alert alert-info" style="margin-top: 1.5rem;">
                    <div class="alert-content">
                        <div class="alert-icon">üõ°Ô∏è</div>
                        <div class="alert-message">
                            <strong>Security Features:</strong>
                            <ul style="margin: 0.5rem 0 0 1rem;">
                                <li>5-second execution timeout</li>
                                <li>128MB memory limit</li>
                                <li>No file system access</li>
                                <li>No network access</li>
                                <li>Isolated sandbox environment</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar Panel -->
    <div class="sidebar-panel">
        <!-- Sample Gallery -->
        <div class="sidebar-card">
            <div class="sidebar-card-header">
                <h3 class="sidebar-card-title">üéØ Try Sample Modules</h3>
            </div>
            <div class="sidebar-card-body">
                <div class="samples-grid-modern">
                    <div class="sample-card-modern" data-sample="calc_add">
                        <div class="sample-card-title">üßÆ Basic Addition</div>
                        <div class="sample-card-description">
                            Simple calculator that adds two numbers together. Great for testing basic WASM functionality.
                        </div>
                    </div>
                    <div class="sample-card-modern" data-sample="echo">
                        <div class="sample-card-title">üì¢ Echo Module</div>
                        <div class="sample-card-description">
                            Echoes the input data back to output. Perfect for testing input/output functionality.
                        </div>
                    </div>
                    <div class="sample-card-modern" data-sample="hello_world">
                        <div class="sample-card-title">üëã Hello World</div>
                        <div class="sample-card-description">
                            Classic "Hello, World!" program compiled to WebAssembly. No input required.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="sidebar-card">
            <div class="sidebar-card-header">
                <h3 class="sidebar-card-title">üìä Platform Stats</h3>
            </div>
            <div class="sidebar-card-body">
                <div style="display: grid; gap: 1rem;">
                    <div style="text-align: center; padding: 0.75rem; background: var(--background-color); border-radius: 6px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">10,000+</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Modules Executed</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--background-color); border-radius: 6px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--secondary-color);">99.9%</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Uptime</div>
                    </div>
                    <div style="text-align: center; padding: 0.75rem; background: var(--background-color); border-radius: 6px;">
                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">&lt;200ms</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Avg Response</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Help & Resources -->
        <div class="sidebar-card">
            <div class="sidebar-card-header">
                <h3 class="sidebar-card-title">ü§ù Need Help?</h3>
            </div>
            <div class="sidebar-card-body">
                <div style="display: grid; gap: 0.5rem;">
                    <a href="/docs" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 4px; text-decoration: none; color: var(--text-primary); transition: background 0.15s;">
                        üìñ <span>Documentation</span>
                    </a>
                    <a href="/examples" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 4px; text-decoration: none; color: var(--text-primary); transition: background 0.15s;">
                        üß© <span>Code Examples</span>
                    </a>
                    <a href="/support" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 4px; text-decoration: none; color: var(--text-primary); transition: background 0.15s;">
                        üí¨ <span>Get Support</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Action Button -->
<button class="fab" id="fab-execute" title="Execute WASM" style="display: none;">
    ‚ö°
</button>

<style>
/* Additional component-specific styles */
.alert-content {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
}

.alert-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
}

.alert-message {
    flex: 1;
}

.alert-message ul {
    margin: 0.5rem 0 0 1rem;
    color: inherit;
}

.sidebar-card a:hover {
    background: var(--background-color) !important;
}

/* Enhanced execution result styling */
.execution-result-card {
    background: white;
    border-radius: 12px;
    box-shadow: var(--medium-shadow);
    border: 1px solid var(--border-color);
    margin-top: 2rem;
    overflow: hidden;
}

.result-header {
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 2rem;
    font-weight: 600;
    font-size: 0.875rem;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-badge.success {
    background: #dcfce7;
    color: #166534;
}

.status-badge.error {
    background: #fee2e2;
    color: #991b1b;
}

.result-section {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: #f9fafb;
    border-radius: 8px;
}

.code-output {
    background-color: #1a1b26;
    color: #a9b1d6;
    padding: 1.5rem;
    border-radius: 8px;
    font-family: 'Fira Code', monospace;
    white-space: pre-wrap;
    margin: 0.5rem 0;
    font-size: 0.875rem;
    line-height: 1.6;
    overflow-x: auto;
}

.error-section {
    background: #fef2f2;
    border-left: 4px solid #ef4444;
}

.result-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding: 1.5rem;
    background: var(--background-color);
}

.result-actions button {
    flex: 1;
}
</style>
{% endblock %}

{% block scripts %}
<script>
// Enhanced JavaScript for the modern interface
document.addEventListener('DOMContentLoaded', function() {
    // Initialize modern UI components
    initializeCollapsibleSections();
    initializeInputTabs();
    initializeSampleCards();
    initializeFloatingActionButton();
    
    // File upload interaction (existing)
    const fileUpload = document.querySelector('.enhanced-upload-zone');
    const fileInput = document.querySelector('#wasm-file');
    const apiKeyInput = document.querySelector('#api-key');
    
    // Load saved API key
    const savedApiKey = localStorage.getItem('wasmwiz-api-key');
    if (savedApiKey) {
        apiKeyInput.value = savedApiKey;
    }
    
    // Save API key when changed
    apiKeyInput.addEventListener('change', function() {
        localStorage.setItem('wasmwiz-api-key', this.value);
    });
    
    // File upload click handler
    fileUpload.addEventListener('click', function() {
        fileInput.click();
    });
});

function initializeCollapsibleSections() {
    const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
    
    collapsibleHeaders.forEach(header => {
        header.addEventListener('click', function() {
            const section = this.parentElement;
            const isExpanded = section.classList.contains('expanded');
            
            // Close all other sections
            document.querySelectorAll('.collapsible-section').forEach(s => {
                if (s !== section) {
                    s.classList.remove('expanded');
                }
            });
            
            // Toggle current section
            section.classList.toggle('expanded', !isExpanded);
        });
    });
}

function initializeInputTabs() {
    const tabs = document.querySelectorAll('.input-tab');
    const inputField = document.querySelector('#input-text');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked tab
            this.classList.add('active');
            
            // Update input field placeholder based on selected type
            const inputType = this.dataset.inputType;
            updateInputPlaceholder(inputType, inputField);
        });
    });
}

function updateInputPlaceholder(type, inputField) {
    const placeholders = {
        text: 'Enter plain text input for your WebAssembly module...',
        json: '{\n  "key": "value",\n  "number": 42\n}',
        binary: 'SGVsbG8gV29ybGQ='  // Base64 encoded "Hello World"
    };
    
    inputField.placeholder = placeholders[type] || placeholders.text;
    
    // Add syntax highlighting class if needed
    inputField.className = `modern-form-input input-type-${type}`;
}

function initializeSampleCards() {
    const sampleCards = document.querySelectorAll('.sample-card-modern');
    
    sampleCards.forEach(card => {
        card.addEventListener('click', function() {
            // Remove selected class from all cards
            sampleCards.forEach(c => c.classList.remove('selected'));
            
            // Add selected class to clicked card
            this.classList.add('selected');
            
            // Load sample data (this would call existing sample loading logic)
            const sampleType = this.dataset.sample;
            loadSampleModule(sampleType);
        });
    });
}

function initializeFloatingActionButton() {
    const fab = document.querySelector('#fab-execute');
    const submitButton = document.querySelector('#submit-button');
    
    // Show FAB when scrolling down
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        
        if (window.scrollY > 200) {
            fab.style.display = 'block';
        } else {
            fab.style.display = 'none';
        }
        
        scrollTimeout = setTimeout(() => {
            if (window.scrollY > 200) {
                fab.style.display = 'block';
            }
        }, 100);
    });
    
    // FAB click handler
    fab.addEventListener('click', function() {
        // Scroll to top and trigger submit
        window.scrollTo({ top: 0, behavior: 'smooth' });
        setTimeout(() => {
            submitButton.click();
        }, 500);
    });
}

function loadSampleModule(sampleType) {
    // This function would integrate with existing sample loading logic
    console.log(`Loading sample: ${sampleType}`);
    
    // Example integration with existing code
    if (window.loadSample) {
        window.loadSample(sampleType);
    }
}

// Enhanced progress indicator
function updateProgress(step, percentage) {
    const progressBar = document.querySelector('#progress-bar');
    const progressPercentage = document.querySelector('#progress-percentage');
    const steps = document.querySelectorAll('.progress-step-modern');
    
    if (progressBar) {
        progressBar.style.width = percentage + '%';
    }
    
    if (progressPercentage) {
        progressPercentage.textContent = percentage + '%';
    }
    
    // Update step indicators
    steps.forEach((stepEl, index) => {
        stepEl.classList.remove('active', 'completed');
        
        if (index < step) {
            stepEl.classList.add('completed');
        } else if (index === step) {
            stepEl.classList.add('active');
        }
    });
}

// Export functions for integration with existing code
window.WasmWizUI = {
    updateProgress,
    showProgress: () => {
        const container = document.querySelector('#progress-container');
        if (container) container.style.display = 'block';
    },
    hideProgress: () => {
        const container = document.querySelector('#progress-container');
        if (container) container.style.display = 'none';
    },
    setExecutingState: (isExecuting) => {
        const fab = document.querySelector('#fab-execute');
        const submitButton = document.querySelector('#submit-button');
        
        if (isExecuting) {
            fab.classList.add('executing');
            submitButton.disabled = true;
            submitButton.innerHTML = '<span class="spinner"></span> Executing...';
        } else {
            fab.classList.remove('executing');
            submitButton.disabled = false;
            submitButton.innerHTML = 'üöÄ Execute WebAssembly Module';
        }
    }
};
</script>
{% endblock %}
